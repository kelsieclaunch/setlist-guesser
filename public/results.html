<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Quiz Results</title>
<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  body {
    background:black;
    color:white;
    font-family:'Poppins',sans-serif;
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100dvh;
  }

  .header {
    width:100%;
    background:rgba(0,0,0,0.85);
    padding:10px 20px;
    border-bottom:2px solid #fc0fc0;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:fixed;
    top:0;
    z-index:1000;
    box-sizing:border-box;
  }
  .header a.logo { color:#fff; font-weight:700; text-decoration:none; font-size:1.2em; }
  .navbar a { color:#fff; text-decoration:none; font-weight:600; margin-left:15px; }
  .navbar a:hover { color:#fc0fc0; text-shadow:0 0 8px #fc0fc0; }

  main {
    margin-top:70px; /* push content below fixed header */
    width:90%;
    max-width:900px;
    text-align:center;
  }

  h1 { color:#fc0fc0; margin-bottom:10px; }
  #quiz-name, #score-display {
    font-weight:600;
    font-size:1.1em;
    margin-top:5px;
    margin-bottom:5px;
    color:#fff;
  }

  .results-container {
    display:flex;
    justify-content:space-between;
    gap:20px;
    margin-top:20px;
    flex-wrap:wrap;
  }
  .column {
    flex:1;
    background:rgba(0,0,0,0.85);
    padding:20px;
    border:2px solid #ffff33;
    border-radius:12px;
    box-sizing:border-box;
    min-width:250px;
  }
  .column h2 { margin-top:0; color:#ffff33; font-size: 1.1rem; }
  .q-row { margin-bottom:12px; text-align:left; }
  .q-label { font-weight:600; display:inline-block; width:150px; }
  ul.surprise-songs { margin:0; padding-left:20px; }
  .no-submission { color:#fc0fc0; font-style:italic; margin-top:10px; }

  @media (max-width: 700px) {
    .results-container { flex-direction: column; }
  }
</style>
</head>
<body>
<header class="header">
  <a href="home.html" class="logo">Parx Predict</a>
  <nav class="navbar">
    <a href="home.html">Home</a>
    <a href="leaderboard.html">Leaderboard</a>
    <a href="#" id="logout">Logout</a>
  </nav>
</header>

<main>
  <h1>Results</h1>
  <div id="quiz-name"></div> <!-- show name -->
  <p id="score-display">Score: -</p>
  <p style="text-align:center; font-size:0.9em; color:#fc0fc0;">
    Reminder: Surprise songs are worth 2 points, all other questions are worth 1 point. Order of surprise songs doesn't matter.
  </p>

  <div class="results-container">
    <div class="column" id="user-guesses">
      <h2>Your Guesses</h2>
    </div>
    <div class="column" id="correct-answers">
      <h2>Correct Answers</h2>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const quizSlug = urlParams.get("slug");
  if (!quizSlug) return;

  const quizNameEl = document.getElementById("quiz-name");
  quizNameEl.textContent = `Show: ${quizSlug.charAt(0).toUpperCase() + quizSlug.slice(1)}`;

  const userCol = document.getElementById("user-guesses");
  const correctCol = document.getElementById("correct-answers");
  const scoreDisplay = document.getElementById("score-display");

  try {
    const res = await fetch(`/quiz/${quizSlug}/results`, { credentials:'include' });
    if (!res.ok) throw new Error("Failed to fetch results");
    const data = await res.json();
    const submission = data.submission;
    const answers = data.answers;

    // Fetch score
    let score = "-";
    const scoreRes = await fetch(`/quiz/${quizSlug}/score`, { credentials:'include' });
    if (scoreRes.ok) {
      const scoreData = await scoreRes.json();
      if (scoreData.score != null) score = scoreData.score;
    }
    scoreDisplay.textContent = `Score: ${score}`;

    if (!submission) userCol.innerHTML += `<p class="no-submission">No guesses submitted.</p>`;
    if (!answers) correctCol.innerHTML += `<p class="no-submission">Answer key not yet available.</p>`;

    const exactQs = ["q1","q2","q6","q7"];
    const surpriseQs = ["q3","q4","q5"];

    exactQs.forEach(q => {
      const userVal = submission ? submission[q] : "-";
      const correctVal = answers ? answers[q] : "-";

      const uDiv = document.createElement("div");
      uDiv.className = "q-row";
      uDiv.innerHTML = `<span class="q-label">${q.toUpperCase()}</span>${userVal}`;
      userCol.appendChild(uDiv);

      const cDiv = document.createElement("div");
      cDiv.className = "q-row";

      if (Array.isArray(correctVal)) {
        cDiv.innerHTML = `<span class="q-label">${q.toUpperCase()}</span>
          <ul style="margin:0; padding-left:18px;">
            ${correctVal.map(v => `<li>${v}</li>`).join("")}
          </ul>`;
      } else {
        cDiv.innerHTML = `<span class="q-label">${q.toUpperCase()}</span>${correctVal}`;
      }

      correctCol.appendChild(cDiv);
    });

    // Surprise song handling
    const userSurprise = submission ? surpriseQs.map(q => submission[q] || "-") : surpriseQs.map(() => "-");
    const correctSurprise = answers ? answers.q3 || [] : [];

    // --- USER COLUMN ---
    const uDiv = document.createElement("div");
    uDiv.className = "q-row";
    uDiv.innerHTML = `<span class="q-label">Surprise Songs</span>
                      <ul class="surprise-songs">${userSurprise.map(s=>`<li>${s}</li>`).join("")}</ul>`;
    userCol.appendChild(uDiv);

    // --- CORRECT ANSWER COLUMN ---
    const cDiv = document.createElement("div");
    cDiv.className = "q-row";

    if (!correctSurprise || correctSurprise.length === 0 || correctSurprise.every(s => !s)) {
      // No surprise songs
      cDiv.innerHTML = `<span class="q-label">Surprise Songs</span>
                        <p style="color:#fc0fc0; font-style:italic; margin-top:6px;">
                          No surprise songs were played at this show.
                        </p>`;
    } else {
      // Songs exist
      cDiv.innerHTML = `<span class="q-label">Surprise Songs</span>
                        <ul class="surprise-songs">${correctSurprise.map(s=>`<li>${s}</li>`).join("")}</ul>`;
    }

    correctCol.appendChild(cDiv);

  } catch(err) {
    console.error(err);
    alert("Error loading results");
  }

  document.getElementById('logout').addEventListener('click', async e=>{
    e.preventDefault();
    await fetch('/logout',{method:'POST', credentials:'include'});
    window.location.href = '/';
  });
});
</script>
</body>
</html>
